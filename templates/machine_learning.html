{% extends 'base.html' %}

{% block title %}Machine Learning Course - {{ mlCourseData.instructor }}{% endblock %}

{% block extra_css %}
<style>
    .hero-ml {
        background: linear-gradient(rgba(40, 50, 100, 0.7), rgba(20, 60, 90, 0.7)), url('https://images.unsplash.com/photo-1518770660439-4636190af475?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8bWFjaGluZSUyMGxlYXJuaW5nfGVufDB8fDB8fHww&auto=format&fit=crop&w=800&q=60') no-repeat center center;
        background-size: cover;
        color: white;
        padding: 60px 20px;
        margin-bottom: 30px;
    }
    .video-container {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 */
        height: 0;
        overflow: hidden;
        max-width: 100%;
        background: #000;
        margin-bottom: 15px;
    }
    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .topic-card {
        margin-bottom: 2rem;
    }
    .topic-card .card-header {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    .resource-list {
        padding-left: 0;
        list-style: none;
    }
    .resource-list li {
        padding: 0.25rem 0;
        font-size: 0.9rem;
    }
    .resource-list li i {
        margin-right: 8px;
        color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
    <section class="hero-ml">
        <div class="container text-center">
            <h1 id="ml-course-title"></h1>
            <p class="lead">Instructor: <span id="ml-instructor-name"></span></p>
            <div id="ml-general-links" class="mb-3">
                <!-- General links will be populated here -->
            </div>
            <p class="fst-italic" id="ml-prerequisite"></p>
        </div>
    </section>

    <section class="py-5">
        <div class="container">
            <h2 class="mb-4 text-center">Course Topics & Resources</h2>
            <div id="ml-topics-container">
                <!-- Topics will be dynamically inserted here by JavaScript -->
            </div>

            <div id="ml-general-references-section" class="mt-5">
                 <!-- General ML References will be dynamically inserted here -->
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
    <script src="{{ url_for('static', filename='js/ml.js') }}"></script>
    <script>
        // Helper function to extract YouTube Video ID (same as DL page)
        function getYoutubeVideoId(url) {
            if (!url) return null;
            let videoId = null;
            const youtubeRegex = [
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&#]+)/,
                /(?:https?:\/\/)?youtu\.be\/([^?#]+)/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([^?#]+)/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/v\/([^?#]+)/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?.*v=([^&]+)/
            ];
            for (const regex of youtubeRegex) {
                const match = url.match(regex);
                if (match && match[1]) {
                    videoId = match[1];
                    break;
                }
            }
            if (videoId) {
                if (/^[a-zA-Z0-9\-_İусх]+$/.test(videoId)) { return videoId; }
            }
            console.warn("Could not extract video ID from URL:", url);
            return null;
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof mlCourseData === 'undefined') {
                console.error("CRITICAL: mlCourseData object is not defined.");
                return;
            }

            // Populate header info
            document.getElementById('ml-course-title').textContent = mlCourseData.courseTitle;
            document.getElementById('ml-instructor-name').textContent = mlCourseData.instructor;
            document.getElementById('ml-prerequisite').textContent = mlCourseData.prerequisite;
            
            // Populate general links
            const generalLinksContainer = document.getElementById('ml-general-links');
            mlCourseData.generalLinks.forEach(link => {
                generalLinksContainer.innerHTML += `<a href="${link.url}" class="btn btn-sm btn-outline-light me-2" target="_blank" rel="noopener noreferrer">${link.text}</a> `;
            });
            
            // Populate Jinja Title (Passed from Flask route)
            // This is for the <title> tag, passed via the Flask route
            // document.title = `Machine Learning Course - ${mlCourseData.instructor}`; // Not needed if Flask route sets it

            const topicsContainer = document.getElementById('ml-topics-container');
            if (!topicsContainer) {
                console.error("Topics container not found!");
                return;
            }

            mlCourseData.topics.forEach((topic, index) => {
                let youtubeHtml = '';
                if (topic.youtubeLinks && topic.youtubeLinks.length > 0) {
                    youtubeHtml += `<h5 class="mt-3"><i class="fab fa-youtube text-danger me-2"></i>YouTube Links</h5><div class="row">`;
                    topic.youtubeLinks.forEach(link => {
                        const videoId = getYoutubeVideoId(link);
                        if (videoId) {
                            youtubeHtml += `
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100">
                                        <div class="video-container">
                                            <iframe src="https://www.youtube.com/embed/${videoId}" 
                                                    title="YouTube video for ${topic.topicName}" 
                                                    frameborder="0" 
                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                                    allowfullscreen>
                                            </iframe>
                                        </div>
                                    </div>
                                </div>`;
                        } else {
                             youtubeHtml += `
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100"><div class="card-body"><p class="card-text small"><i class="fas fa-exclamation-triangle text-warning me-1"></i>Could not embed: <a href="${link}" target="_blank">${link}</a></p></div></div>
                                </div>`;
                        }
                    });
                    youtubeHtml += '</div>';
                }

                let referencesHtml = '';
                if (topic.references && topic.references.length > 0) {
                    referencesHtml += `<h5 class="mt-3"><i class="fas fa-book-reader text-primary me-2"></i>References</h5><ul class="resource-list">`;
                    topic.references.forEach(ref => {
                        referencesHtml += `<li><i class="fas fa-link"></i><a href="${ref.url}" target="_blank" rel="noopener noreferrer">${ref.text}</a></li>`;
                    });
                    referencesHtml += `</ul>`;
                }

                let codesAndDatasetsHtml = '';
                if (topic.codesAndDatasets && topic.codesAndDatasets.length > 0) {
                    codesAndDatasetsHtml += `<h5 class="mt-3"><i class="fas fa-code text-success me-2"></i>Codes and Datasets</h5><ul class="resource-list">`;
                    topic.codesAndDatasets.forEach(item => {
                        codesAndDatasetsHtml += `<li><i class="fas fa-file-alt"></i><a href="${item.url}" target="_blank" rel="noopener noreferrer">${item.text}</a></li>`;
                    });
                    codesAndDatasetsHtml += `</ul>`;
                }

                const topicCard = `
                    <div class="card topic-card" id="topic-${index}">
                        <div class="card-header">
                            ${topic.topicName}
                        </div>
                        <div class="card-body">
                            ${youtubeHtml}
                            ${referencesHtml}
                            ${codesAndDatasetsHtml}
                        </div>
                    </div>`;
                topicsContainer.innerHTML += topicCard;
            });

            // Populate General ML References
            const generalMlRefsSection = document.getElementById('ml-general-references-section');
            if (generalMlRefsSection && mlCourseData.generalMlReferences && mlCourseData.generalMlReferences.length > 0) {
                let generalRefsHtml = `
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="fas fa-cogs me-2"></i>General Further Learning</h4>
                        </div>
                        <ul class="list-group list-group-flush">`;
                mlCourseData.generalMlReferences.forEach(ref => {
                    generalRefsHtml += `<li class="list-group-item">
                                        <a href="${ref.url}" target="_blank" rel="noopener noreferrer">${ref.text}</a>
                                      </li>`;
                });
                generalRefsHtml += `</ul></div>`;
                generalMlRefsSection.innerHTML = generalRefsHtml;
            }
        });
    </script>
{% endblock %}
