{% extends 'base.html' %}

{# The instructor_name variable will be passed from your Flask route #}
{% block title %}Deep Learning Course - By {{ instructor_name }}{% endblock %}

{% block extra_css %}
<style>
    .hero-dl {
        background: linear-gradient(rgba(29, 38, 113, 0.7), rgba(19, 73, 100, 0.7)), url('https://images.unsplash.com/photo-1504868584819-f8e8b4b6d7e3?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8ZGF0YSUyMHNjaWVuY2V8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=800&q=60') no-repeat center center;
        background-size: cover;
        color: white;
        padding: 60px 20px;
        margin-bottom: 30px;
    }
    .video-container {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
        max-width: 100%;
        background: #000;
        margin-bottom: 15px;
    }
    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .accordion-button:not(.collapsed) {
        color: #0c63e4;
        background-color: #e7f1ff;
    }
    .list-group-item a {
        text-decoration: none;
    }
    .list-group-item a:hover {
        text-decoration: underline;
    }
    .section-divider {
        margin-top: 20px;
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
    }
    .primary-material-section h5 {
        margin-top: 20px;
        margin-bottom: 10px;
        color: #333;
        border-left: 3px solid #007bff;
        padding-left: 10px;
    }
</style>
{% endblock %}

{% block content %}
    <section class="hero-dl">
        <div class="container text-center">
            <h1>Deep Learning Course</h1>
            {# These spans will be populated by JavaScript using courseData from dl.js #}
            <p class="lead">Instructor: <span id="instructor-name"></span></p>
            <p>Before starting Deep Learning, make sure to first learn basics of <span id="prerequisite-subject"></span>.</p>
        </div>
    </section>

    <section class="py-5">
        <div class="container">
            <h2 class="mb-4 text-center">Course Content</h2>

            <div class="accordion" id="courseAccordion">
                <!-- Weeks will be dynamically inserted here by JavaScript -->
            </div>

            <div id="textbooks-section" class="mt-5">
                <!-- Textbooks will be dynamically inserted here -->
            </div>

            <div id="nlp-references-section" class="mt-5">
                <!-- NLP References will be dynamically inserted here -->
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
    {# Ensure this filename matches your actual JS file containing the courseData object #}
    <script src="{{ url_for('static', filename='js/dl.js') }}"></script>
    {# Changed from dl.js to dl_data.js as that's where courseData is likely defined #}

    <script>
        // Helper function to extract YouTube Video ID
        function getYoutubeVideoId(url) {
            if (!url) return null;
            let videoId = null;
            const youtubeRegex = [
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&#]+)/,
                /(?:https?:\/\/)?youtu\.be\/([^?#]+)/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([^?#]+)/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/v\/([^?#]+)/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?.*v=([^&]+)/
            ];
            for (const regex of youtubeRegex) {
                const match = url.match(regex);
                if (match && match[1]) {
                    videoId = match[1];
                    break;
                }
            }
            if (videoId) {
                if (/^[a-zA-Z0-9\-_İусх]+$/.test(videoId)) {
                    return videoId;
                }
            }
            console.warn("Could not extract video ID from URL:", url);
            return null;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Check if courseData is loaded from dl_data.js
            if (typeof courseData === 'undefined') {
                console.error("CRITICAL: courseData object is not defined. Ensure dl_data.js is loaded correctly and defines 'courseData'.");
                // Optionally, display a message to the user on the page
                document.getElementById('instructor-name').textContent = "Error: Data not loaded";
                document.getElementById('prerequisite-subject').textContent = "Error: Data not loaded";
                return; // Stop further execution if data is missing
            }

            // Populate header info in the body using JavaScript
            document.getElementById('instructor-name').textContent = courseData.instructor;
            document.getElementById('prerequisite-subject').textContent = courseData.prerequisite;

            const courseAccordion = document.getElementById('courseAccordion');
            if (!courseAccordion) {
                console.error("CRITICAL: Element with ID 'courseAccordion' not found.");
                return;
            }

            courseData.weeks.forEach((week, index) => {
                const weekId = `week-${week.weekNumber}`;
                const collapseId = `collapse-${week.weekNumber}`;

                let primaryMaterialHtml = '';
                if (week.primaryMaterial && week.primaryMaterial.length > 0) {
                    primaryMaterialHtml += `<h6><i class="fas fa-video me-2 text-danger"></i>Primary YouTube Links</h6>`;
                    week.primaryMaterial.forEach(section => {
                        if (section.title) {
                             primaryMaterialHtml += `<div class="primary-material-section"><h5>${section.title}</h5></div>`;
                        }
                        if (section.videos && section.videos.length > 0) {
                            primaryMaterialHtml += '<div class="row">';
                            section.videos.forEach(video => {
                                const videoId = getYoutubeVideoId(video.url);
                                if (videoId) {
                                    primaryMaterialHtml += `
                                        <div class="col-md-6 col-lg-4 mb-3">
                                            <div class="card h-100">
                                                <div class="video-container">
                                                    <iframe src="https://www.youtube.com/embed/${videoId}"
                                                            title="${video.description || section.title || 'YouTube video player'}"
                                                            frameborder="0"
                                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                                            allowfullscreen>
                                                    </iframe>
                                                </div>
                                                <div class="card-body py-2">
                                                    <p class="card-text small mb-0">${video.description || 'Related Video'}</p>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    primaryMaterialHtml += `
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body py-2">
                                                <p class="card-text small mb-0">
                                                    <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                                    Could not embed: <a href="${video.url}" target="_blank" rel="noopener noreferrer">${video.description || video.url}</a>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                }
                            });
                            primaryMaterialHtml += '</div>';
                        }
                    });
                } else {
                     primaryMaterialHtml = '<p><em>No primary YouTube links for this week.</em></p>';
                }


                let otherReferencesHtml = '';
                if (week.otherReferences && week.otherReferences.length > 0) {
                    otherReferencesHtml += `<div class="section-divider"></div><h6><i class="fas fa-link me-2 text-info"></i>Other References</h6><ul class="list-group list-group-flush">`;
                    week.otherReferences.forEach(ref => {
                        otherReferencesHtml += `
                            <li class="list-group-item">
                                <a href="${ref.url}" target="_blank" rel="noopener noreferrer">${ref.title}</a>
                            </li>`;
                    });
                    otherReferencesHtml += `</ul>`;
                } else {
                    // No need to add "No other references" if primary material is also empty.
                    // It can make the UI cleaner. Or add it if you prefer:
                    // otherReferencesHtml = '<p><em>No other references for this week.</em></p>';
                }

                const accordionItem = `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-${weekId}">
                            <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="${index === 0 ? 'true' : 'false'}" aria-controls="${collapseId}">
                                <strong>Week ${week.weekNumber}: ${week.topic}</strong>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="heading-${weekId}" data-bs-parent="#courseAccordion">
                            <div class="accordion-body">
                                ${primaryMaterialHtml}
                                ${otherReferencesHtml}
                            </div>
                        </div>
                    </div>
                `;
                courseAccordion.innerHTML += accordionItem;
            });

            // Populate Textbooks
            const textbooksSection = document.getElementById('textbooks-section');
            if (textbooksSection && courseData.textbooks && courseData.textbooks.length > 0) {
                let textbooksHtml = `
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="fas fa-book-open me-2"></i>Textbooks</h4>
                        </div>
                        <ul class="list-group list-group-flush">`;
                courseData.textbooks.forEach(book => {
                    textbooksHtml += `<li class="list-group-item">
                                        ${book.title}
                                        ${book.url ? `(<a href="${book.url}" target="_blank" rel="noopener noreferrer">Link</a>)` : ''}
                                      </li>`;
                });
                textbooksHtml += `</ul></div>`;
                textbooksSection.innerHTML = textbooksHtml;
            }

            // Populate NLP References
            const nlpReferencesSection = document.getElementById('nlp-references-section');
            if (nlpReferencesSection) {
                if (courseData.referencesForNLP && courseData.referencesForNLP.length > 0) {
                    let nlpRefHtml = `
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-file-alt me-2"></i>References for NLP</h4>
                            </div>
                            <ul class="list-group list-group-flush">`;
                    courseData.referencesForNLP.forEach(ref => {
                        nlpRefHtml += `<li class="list-group-item">
                                            ${ref.url ? `<a href="${ref.url}" target="_blank" rel="noopener noreferrer">${ref.title}</a>` : ref.title}
                                       </li>`;
                    });
                    nlpRefHtml += `</ul></div>`;
                    nlpReferencesSection.innerHTML = nlpRefHtml;
                } else {
                     let nlpRefHtml = `
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-file-alt me-2"></i>References for NLP</h4>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Refer to NLP specific sections within weekly materials or standard NLP literature.</p>
                            </div>
                        </div>`;
                     nlpReferencesSection.innerHTML = nlpRefHtml;
                }
            }

        });
    </script>
{% endblock %}
